import json
import os
import time
import datetime
import calendar
import urllib.request
import urllib.parse
import traceback

BOT_TOKEN = "8469000525:AAFmCg5qGEEWxCuW997n51wV2AdN7hmJVYQ"
BASE_URL = f"https://api.telegram.org/bot{BOT_TOKEN}/"
DATA_DIR = "data"
USERS_FILE = os.path.join(DATA_DIR, "users.json")
TASKS_FILE = os.path.join(DATA_DIR, "tasks.json")

MONTHS = [
    "", "–°—ñ—á–µ–Ω—å", "–õ—é—Ç–∏–π", "–ë–µ—Ä–µ–∑–µ–Ω—å", "–ö–≤—ñ—Ç–µ–Ω—å", "–¢—Ä–∞–≤–µ–Ω—å", "–ß–µ—Ä–≤–µ–Ω—å",
    "–õ–∏–ø–µ–Ω—å", "–°–µ—Ä–ø–µ–Ω—å", "–í–µ—Ä–µ—Å–µ–Ω—å", "–ñ–æ–≤—Ç–µ–Ω—å", "–õ–∏—Å—Ç–æ–ø–∞–¥", "–ì—Ä—É–¥–µ–Ω—å"
]
WEEKDAYS_UA = ["–ü–Ω", "–í—Ç", "–°—Ä", "–ß—Ç", "–ü—Ç", "–°–±", "–ù–¥"]

CATEGORIES = ["üíº –†–æ–±–æ—Ç–∞", "üéì –ù–∞–≤—á–∞–Ω–Ω—è", "üè† –î—ñ–º", "üõç –ü–æ–∫—É–ø–∫–∏", "üé® –•–æ–±—ñ", "–Ü–Ω—à–∞..."]
PRIORITIES = ["–ù–∏–∑—å–∫–∏–π", "–°–µ—Ä–µ–¥–Ω—ñ–π", "–í–∏—Å–æ–∫–∏–π"]

REMINDER_INTERVAL_SECONDS = 3600

def ensure_data_dir():
    if not os.path.exists(DATA_DIR):
        os.makedirs(DATA_DIR)

def load_json(filename):
    ensure_data_dir()
    if not os.path.exists(filename):
        with open(filename, "w", encoding="utf-8") as f:
            json.dump({}, f)
    with open(filename, "r", encoding="utf-8") as f:
        try:
            return json.load(f)
        except Exception:
            return {}

def save_json(filename, data):
    ensure_data_dir()
    with open(filename, "w", encoding="utf-8") as f:
        json.dump(data, f, indent=2, ensure_ascii=False)

def api_call(method, params):
    url = BASE_URL + method
    data = urllib.parse.urlencode(params).encode("utf-8")
    req = urllib.request.Request(url, data=data)
    try:
        with urllib.request.urlopen(req, timeout=30) as resp:
            return json.loads(resp.read().decode("utf-8"))
    except Exception as e:
        print("api_call error:", e)
        return None

def send_message(chat_id, text, reply_markup=None, parse_mode="HTML"):
    params = {"chat_id": chat_id, "text": text}
    if parse_mode:
        params["parse_mode"] = parse_mode
    if reply_markup is not None:
        params["reply_markup"] = json.dumps(reply_markup, ensure_ascii=False)
    return api_call("sendMessage", params)

def edit_message_text(chat_id, message_id, text, reply_markup=None, parse_mode="HTML"):
    params = {"chat_id": chat_id, "message_id": message_id, "text": text}
    if parse_mode:
        params["parse_mode"] = parse_mode
    if reply_markup is not None:
        params["reply_markup"] = json.dumps(reply_markup, ensure_ascii=False)
    return api_call("editMessageText", params)

def answer_callback(callback_id, text=None, show_alert=False):
    params = {"callback_query_id": callback_id}
    if text:
        params["text"] = text
        params["show_alert"] = "true" if show_alert else "false"
    return api_call("answerCallbackQuery", params)

def main_keyboard_markup():
    keyboard = [["‚ûï –î–æ–¥–∞—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è", "üìã –ú–æ—ó –∑–∞–≤–¥–∞–Ω–Ω—è"], ["üîÑ –ü–æ—á–∞—Ç–∏ —Å–ø–æ—á–∞—Ç–∫—É"]]
    return {"keyboard": keyboard, "resize_keyboard": True}

def inline_categories():
    kb = []
    row = []
    for i, c in enumerate(CATEGORIES, 1):
        row.append({"text": c, "callback_data": f"cat:{i}"})
        if i % 3 == 0:
            kb.append(row)
            row = []
    if row:
        kb.append(row)
    kb.append([{"text": "–°–∫–∞—Å—É–≤–∞—Ç–∏", "callback_data": "cancel"}])
    return {"inline_keyboard": kb}

def inline_priorities():
    kb = []
    row = []
    for i, p in enumerate(PRIORITIES, 1):
        row.append({"text": p, "callback_data": f"prio:{i}"})
    kb.append(row)
    kb.append([{"text": "–°–∫–∞—Å—É–≤–∞—Ç–∏", "callback_data": "cancel"}])
    return {"inline_keyboard": kb}

def build_inline_calendar(year, month):
    cal = calendar.monthcalendar(year, month)
    kb = []
    # header: month year (non-clickable)
    kb.append([{"text": f"{MONTHS[month]} {year}", "callback_data": "ignore"}])
    # weekdays row
    weekday_row = [{"text": wd, "callback_data": "ignore"} for wd in WEEKDAYS_UA]
    kb.append(weekday_row)
    # day rows
    for week in cal:
        row = []
        for day in week:
            if day == 0:
                row.append({"text": " ", "callback_data": "ignore"})
            else:
                row.append({"text": str(day), "callback_data": f"cal:day:{year}:{month}:{day}"})
        kb.append(row)
    # prev/next row
    prev_month = month - 1 if month > 1 else 12
    prev_year = year if month > 1 else year - 1
    next_month = month + 1 if month < 12 else 1
    next_year = year if month < 12 else year + 1
    kb.append([
        {"text": f"¬´ {MONTHS[prev_month]} {prev_year}", "callback_data": f"cal:prev:{prev_year}:{prev_month}"},
        {"text": f"{MONTHS[next_month]} {next_year} ¬ª", "callback_data": f"cal:next:{next_year}:{next_month}"}
    ])
    kb.append([{"text": "–°–∫–∞—Å—É–≤–∞—Ç–∏", "callback_data": "cancel"}])
    return {"inline_keyboard": kb}


def task_action_keyboard(task_id):
    return {
        "inline_keyboard": [
            [
                {"text": "‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏", "callback_data": f"task:edit:{task_id}"},
                {"text": "‚úÖ –í–∏–∫–æ–Ω–∞–Ω–æ", "callback_data": f"task:done:{task_id}"},
                {"text": "üóë –í–∏–¥–∞–ª–∏—Ç–∏", "callback_data": f"task:delete:{task_id}"}
            ]
        ]
    }

def make_task_id():
    return str(int(time.time() * 1000))

def format_task_text(task):
    name = task.get("name", "")
    date = task.get("date", "")
    category = task.get("category", "-")
    priority = task.get("priority", "-")
    desc = task.get("description", "")
    status = task.get("status", "–∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–µ")
    date_display = date
    return (f"üìå <b>{name}</b>\n"
            f"üóì {date_display}\n"
            f"üìÇ {category}    üîî {priority}    ‚úÖ {status}\n"
            f"üìù {desc if desc else '-'}")

def start_or_reset_user(chat_id, users):
    users[str(chat_id)] = {
        "state": "enter_name",
        "temp_task": {},
        "name": None,
        "editing_task": None,
    }
    save_json(USERS_FILE, users)
    greeting = (
        "–ü—Ä–∏–≤—ñ—Ç!\n\n"
        "üí´–Ø ‚Äî —Ç–≤—ñ–π —Ü–∏—Ñ—Ä–æ–≤–∏–π –ø–æ–º—ñ—á–Ω–∏–∫ –ü–ª–∞–Ω—É–≤–∞–ª—å–Ω–∏–∫ –∑–∞–≤–¥–∞–Ω—å.\n"
        "–†–∞–∑–æ–º –º–∏ –≤–ø–æ—Ä–∞—î–º–æ—Å—è –∑ –±—É–¥—å-—è–∫–∏–º —Å–ø–∏—Å–∫–æ–º —Å–ø—Ä–∞–≤ ‚Äî –≤—ñ–¥ –Ω–∞–≤—á–∞–Ω–Ω—è –¥–æ –≤—ñ–¥–ø–æ—á–∏–Ω–∫—É!\n"
        "–ü–æ—á–Ω–µ–º–æ –¥–µ–Ω—å –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ?"
    )
    send_message(chat_id, greeting)
    send_message(chat_id, "üëã –í–≤–µ–¥–∏ —Å–≤–æ—î —ñ–º‚Äô—è (–∞–±–æ –Ω—ñ–∫–Ω–µ–π–º):", reply_markup=main_keyboard_markup())

def list_user_tasks_messages(chat_id, tasks):
    user_tasks = [t for t in tasks.values() if str(t.get("user_id")) == str(chat_id)]
    if not user_tasks:
        send_message(chat_id, "üì≠ –£ —Ç–µ–±–µ —â–µ –Ω–µ–º–∞—î –∑–∞–≤–¥–∞–Ω—å.", reply_markup=main_keyboard_markup())
        return

    try:
        user_tasks.sort(key=lambda x: (x.get("date", ""), x.get("id")))
    except Exception:
        pass
    for t in user_tasks:
        text = format_task_text(t)
        send_message(chat_id, text, reply_markup=task_action_keyboard(t["id"]))

def create_task_from_temp(chat_id, users, tasks):
    user = users.get(str(chat_id))
    temp = user.get("temp_task", {})
    if not temp.get("name") or not temp.get("date"):
        send_message(chat_id, "‚ö†Ô∏è –ù–µ–º–æ–∂–ª–∏–≤–æ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è: –Ω–µ –≤–∏—Å—Ç–∞—á–∞—î –¥–∞–Ω–∏—Ö.", reply_markup=main_keyboard_markup())
        user["state"] = "main_menu"
        user["temp_task"] = {}
        save_json(USERS_FILE, users)
        return
    task_id = make_task_id()
    tasks[task_id] = {
        "id": task_id,
        "user_id": chat_id,
        "name": temp.get("name"),
        "category": temp.get("category", "-"),
        "description": temp.get("description", ""),
        "priority": temp.get("priority", "-"),
        "date": temp.get("date"),
        "status": "–∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–µ",
        "reminder_sent": False
    }
    save_json(TASKS_FILE, tasks)
    send_message(chat_id, f"‚úÖ –ó–∞–≤–¥–∞–Ω–Ω—è ¬´{temp.get('name')}¬ª —Å—Ç–≤–æ—Ä–µ–Ω–æ –Ω–∞ {temp.get('date')}.", reply_markup=main_keyboard_markup())
    user["state"] = "main_menu"
    user["temp_task"] = {}
    save_json(USERS_FILE, users)
    send_message(chat_id, format_task_text(tasks[task_id]), reply_markup=task_action_keyboard(task_id))

def handle_callback(update):
    cq = update["callback_query"]
    data = cq.get("data")
    from_user = cq["from"]
    chat_id = cq["message"]["chat"]["id"] if "message" in cq and "chat" in cq["message"] else from_user["id"]
    callback_id = cq.get("id")
    message = cq.get("message")
    message_id = message.get("message_id") if message else None

    users = load_json(USERS_FILE)
    tasks = load_json(TASKS_FILE)
    user = users.get(str(chat_id), {"state": "main_menu", "temp_task": {}, "editing_task": None})

    try:
        if not data:
            answer_callback(callback_id)
            return

        # Cancel universal
        if data == "cancel":
            user["state"] = "main_menu"
            user["temp_task"] = {}
            user["editing_task"] = None
            users[str(chat_id)] = user
            save_json(USERS_FILE, users)
            answer_callback(callback_id)
            send_message(chat_id, "‚ùå –î—ñ—é —Å–∫–∞—Å–æ–≤–∞–Ω–æ.", reply_markup=main_keyboard_markup())
            return

        if data.startswith("cat:"):
            _, idx = data.split(":")
            idx = int(idx)
            if idx <= len(CATEGORIES):
                chosen = CATEGORIES[idx - 1]
                if chosen == "–Ü–Ω—à–∞...":
                    user["state"] = "custom_category"
                    users[str(chat_id)] = user
                    save_json(USERS_FILE, users)
                    answer_callback(callback_id)
                    send_message(chat_id, "–í–≤–µ–¥–∏ —Å–≤–æ—é –∫–∞—Ç–µ–≥–æ—Ä—ñ—é (–∞–±–æ '–°–∫–∞—Å—É–≤–∞—Ç–∏'):", reply_markup=main_keyboard_markup())
                    return
                else:
                    user["temp_task"]["category"] = chosen
                    user["state"] = "enter_description"
                    users[str(chat_id)] = user
                    save_json(USERS_FILE, users)
                    answer_callback(callback_id)
                    send_message(chat_id, "üìù –í–≤–µ–¥–∏ –æ–ø–∏—Å –∑–∞–≤–¥–∞–Ω–Ω—è (–∞–±–æ –Ω–∞–ø–∏—à–∏ '–ü—Ä–æ–ø—É—Å—Ç–∏—Ç–∏'):", reply_markup=main_keyboard_markup())
                    return

        if data.startswith("prio:"):
            _, idx = data.split(":")
            idx = int(idx)
            if 1 <= idx <= len(PRIORITIES):
                pr = PRIORITIES[idx - 1]
                if user.get("state") == "editing_priority" and user.get("editing_task"):
                    tid = user["editing_task"]
                    tasks = load_json(TASKS_FILE)
                    if tid in tasks:
                        tasks[tid]["priority"] = pr
                        save_json(TASKS_FILE, tasks)
                        send_message(chat_id, "‚úÖ –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç –∑–º—ñ–Ω–µ–Ω–æ.", reply_markup=main_keyboard_markup())
                        user["state"] = "main_menu"
                        user["editing_task"] = None
                        users[str(chat_id)] = user
                        save_json(USERS_FILE, users)
                        answer_callback(callback_id)
                        return
                # else treat as creating flow
                user["temp_task"]["priority"] = pr
                user["state"] = "select_date"
                now = datetime.datetime.now()
                user["temp_task"]["temp_year"] = now.year
                user["temp_task"]["temp_month"] = now.month
                users[str(chat_id)] = user
                save_json(USERS_FILE, users)
                answer_callback(callback_id)
                send_message(chat_id, "üìÖ –û–±–µ—Ä–∏ –¥–∞—Ç—É:", reply_markup=build_inline_calendar(now.year, now.month))
                return

        if data.startswith("cal:"):
            parts = data.split(":")
            action = parts[1]
            if action in ("prev", "next"):
                year = int(parts[2]); month = int(parts[3])
                if action == "prev":
                    m = month - 1
                    y = year
                    if m < 1:
                        m = 12; y -= 1
                else:
                    m = month + 1
                    y = year
                    if m > 12:
                        m = 1; y += 1
                answer_callback(callback_id)
                if message_id:
                    edit_message_text(chat_id, message_id, "üìÖ –û–±–µ—Ä–∏ –¥–∞—Ç—É:", reply_markup=build_inline_calendar(y, m))
                else:
                    send_message(chat_id, "üìÖ –û–±–µ—Ä–∏ –¥–∞—Ç—É:", reply_markup=build_inline_calendar(y, m))
                return
            if action == "day":
                year = int(parts[2]); month = int(parts[3]); day = int(parts[4])
                try:
                    selected = datetime.date(year, month, day)
                except Exception:
                    answer_callback(callback_id, "–ù–µ–≤—ñ—Ä–Ω–∞ –¥–∞—Ç–∞", show_alert=True)
                    return
                if selected < datetime.date.today():
                    answer_callback(callback_id, "–ù–µ –º–æ–∂–Ω–∞ –æ–±—Ä–∞—Ç–∏ –¥–∞—Ç—É –≤ –º–∏–Ω—É–ª–æ–º—É.", show_alert=True)
                    return
                if user.get("state") == "select_date":
                    user["temp_task"]["date"] = selected.isoformat()
                    users[str(chat_id)] = user
                    save_json(USERS_FILE, users)
                    answer_callback(callback_id)
                    # create task now
                    create_task_from_temp(chat_id, users, tasks)
                    return
                if user.get("state") == "editing_date" and user.get("editing_task"):
                    tid = user["editing_task"]
                    if tid in tasks:
                        tasks[tid]["date"] = selected.isoformat()
                        save_json(TASKS_FILE, tasks)
                        answer_callback(callback_id)
                        send_message(chat_id, f"‚úÖ –î–∞—Ç—É –∑–∞–≤–¥–∞–Ω–Ω—è –∑–º—ñ–Ω–µ–Ω–æ –Ω–∞ {selected.isoformat()}.", reply_markup=main_keyboard_markup())
                        user["state"] = "main_menu"
                        user["editing_task"] = None
                        users[str(chat_id)] = user
                        save_json(USERS_FILE, users)
                        return
                    else:
                        answer_callback(callback_id, "–ó–∞–≤–¥–∞–Ω–Ω—è –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.", show_alert=True)
                        return
                answer_callback(callback_id)
                send_message(chat_id, "‚ÑπÔ∏è –ù—ñ—á–æ–≥–æ –Ω–µ –±—É–ª–æ –∑–º—ñ–Ω–µ–Ω–æ (–∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ–≤—ñ–¥–æ–º–∏–π).", reply_markup=main_keyboard_markup())
                return
        if data.startswith("task:"):
            _, action, tid = data.split(":", 2)
            tasks = load_json(TASKS_FILE)
            if tid not in tasks:
                answer_callback(callback_id, "–ó–∞–≤–¥–∞–Ω–Ω—è –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.", show_alert=True)
                return
            if action == "done":
                tasks[tid]["status"] = "–≤–∏–∫–æ–Ω–∞–Ω–µ"
                save_json(TASKS_FILE, tasks)
                answer_callback(callback_id, "–ü–æ–∑–Ω–∞—á–µ–Ω–æ —è–∫ –≤–∏–∫–æ–Ω–∞–Ω–µ.")
                send_message(chat_id, f"‚úÖ –ó–∞–≤–¥–∞–Ω–Ω—è ¬´{tasks[tid]['name']}¬ª –ø–æ–∑–Ω–∞—á–µ–Ω–æ —è–∫ –≤–∏–∫–æ–Ω–∞–Ω–µ.", reply_markup=main_keyboard_markup())
                return
            if action == "delete":
                name = tasks[tid].get("name", "")
                del tasks[tid]
                save_json(TASKS_FILE, tasks)
                answer_callback(callback_id, "–í–∏–¥–∞–ª–µ–Ω–æ.")
                send_message(chat_id, f"üóë –ó–∞–≤–¥–∞–Ω–Ω—è ¬´{name}¬ª –≤–∏–¥–∞–ª–µ–Ω–æ.", reply_markup=main_keyboard_markup())
                return
            if action == "edit":
                user["state"] = "editing_choose_field"
                user["editing_task"] = tid
                users[str(chat_id)] = user
                save_json(USERS_FILE, users)
                answer_callback(callback_id)
                kb = {"inline_keyboard": [
                    [{"text": "–ù–∞–∑–≤—É", "callback_data": "editfield:name"}, {"text": "–ö–∞—Ç–µ–≥–æ—Ä—ñ—é", "callback_data": "editfield:category"}],
                    [{"text": "–û–ø–∏—Å", "callback_data": "editfield:description"}, {"text": "–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç", "callback_data": "editfield:priority"}],
                    [{"text": "–ó–º—ñ–Ω–∏—Ç–∏ –¥–∞—Ç—É", "callback_data": "editfield:date"}],
                    [{"text": "–°–∫–∞—Å—É–≤–∞—Ç–∏", "callback_data": "cancel"}]
                ]}
                send_message(chat_id, "–û–±–µ—Ä—ñ—Ç—å –ø–æ–ª–µ –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è:", reply_markup=kb)
                return
        if data.startswith("editfield:"):
            _, field = data.split(":", 1)
            if field == "date":
                user["state"] = "editing_date"
                users[str(chat_id)] = user
                save_json(USERS_FILE, users)
                now = datetime.datetime.now()
                answer_callback(callback_id)
                send_message(chat_id, "üìÖ –û–±–µ—Ä—ñ—Ç—å –Ω–æ–≤—É –¥–∞—Ç—É:", reply_markup=build_inline_calendar(now.year, now.month))
                return
            if field == "priority":
                user["state"] = "editing_priority"
                users[str(chat_id)] = user
                save_json(USERS_FILE, users)
                answer_callback(callback_id)
                send_message(chat_id, "–û–±–µ—Ä—ñ—Ç—å –Ω–æ–≤–∏–π –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç:", reply_markup=inline_priorities())
                return
            if field == "category":
                user["state"] = "editing_category"
                users[str(chat_id)] = user
                save_json(USERS_FILE, users)
                answer_callback(callback_id)
                send_message(chat_id, "–û–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é –∞–±–æ –≤–≤–µ–¥—ñ—Ç—å —Å–≤–æ—é:", reply_markup=inline_categories())
                return
            if field == "name":
                user["state"] = "editing_name"
                users[str(chat_id)] = user
                save_json(USERS_FILE, users)
                answer_callback(callback_id)
                send_message(chat_id, "–í–≤–µ–¥–∏ –Ω–æ–≤—É –Ω–∞–∑–≤—É –∑–∞–≤–¥–∞–Ω–Ω—è (–∞–±–æ '–°–∫–∞—Å—É–≤–∞—Ç–∏'):", reply_markup=main_keyboard_markup())
                return
            if field == "description":
                user["state"] = "editing_description"
                users[str(chat_id)] = user
                save_json(USERS_FILE, users)
                answer_callback(callback_id)
                send_message(chat_id, "–í–≤–µ–¥–∏ –Ω–æ–≤–∏–π –æ–ø–∏—Å (–∞–±–æ '–ü—Ä–æ–ø—É—Å—Ç–∏—Ç–∏'/'–°–∫–∞—Å—É–≤–∞—Ç–∏'):", reply_markup=main_keyboard_markup())
                return

        answer_callback(callback_id)
    except Exception as e:
        print("handle_callback error:", e)
        traceback.print_exc()
        try:
            answer_callback(callback_id)
        except Exception:
            pass

def process_message(update):
    msg = update.get("message")
    if not msg:
        return
    chat_id = msg["chat"]["id"]
    text = msg.get("text", "").strip()
    users = load_json(USERS_FILE)
    tasks = load_json(TASKS_FILE)
    if str(chat_id) not in users or text in ("üîÑ –ü–æ—á–∞—Ç–∏ —Å–ø–æ—á–∞—Ç–∫—É", "/start"):
        start_or_reset_user(chat_id, users)
        return


    user = users.get(str(chat_id))
    state = user.get("state", "main_menu")

    if state == "enter_name":
        user["name"] = text
        user["state"] = "main_menu"
        user["temp_task"] = {}
        users[str(chat_id)] = user
        save_json(USERS_FILE, users)
        send_message(chat_id, f"‚úÖ –î—è–∫—É—é, {text}! –û–±–µ—Ä–∏ –¥—ñ—é:", reply_markup=main_keyboard_markup())
        return

    if text == "‚ûï –î–æ–¥–∞—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è" and state == "main_menu":
        user["state"] = "enter_task_name"
        user["temp_task"] = {}
        users[str(chat_id)] = user
        save_json(USERS_FILE, users)
        send_message(chat_id, "üìù –í–≤–µ–¥–∏ –Ω–∞–∑–≤—É –∑–∞–≤–¥–∞–Ω–Ω—è:", reply_markup=main_keyboard_markup())
        return

    if text == "üìã –ú–æ—ó –∑–∞–≤–¥–∞–Ω–Ω—è" and state == "main_menu":
        list_user_tasks_messages(chat_id, tasks)
        return

    if state == "enter_task_name":
        user["temp_task"] = {"name": text}
        user["state"] = "select_category"
        users[str(chat_id)] = user
        save_json(USERS_FILE, users)
        send_message(chat_id, f"üìÇ –û–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é –¥–ª—è ¬´{text}¬ª:",
                     reply_markup=inline_categories())
        return

    if state == "custom_category":
        if text == "–°–∫–∞—Å—É–≤–∞—Ç–∏":
            user["state"] = "main_menu"
            user["temp_task"] = {}
            users[str(chat_id)] = user
            save_json(USERS_FILE, users)
            send_message(chat_id, "‚ùå –°–∫–∞—Å–æ–≤–∞–Ω–æ.", reply_markup=main_keyboard_markup())
            return
        user["temp_task"]["category"] = text
        user["state"] = "enter_description"
        users[str(chat_id)] = user
        save_json(USERS_FILE, users)
        send_message(chat_id, "üìù –í–≤–µ–¥–∏ –æ–ø–∏—Å –∑–∞–≤–¥–∞–Ω–Ω—è (–∞–±–æ –Ω–∞–ø–∏—à–∏ '–ü—Ä–æ–ø—É—Å—Ç–∏—Ç–∏'):", reply_markup=main_keyboard_markup())
        return

    if state == "enter_description":
        if text == "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç–∏":
            user["temp_task"]["description"] = ""
        else:
            user["temp_task"]["description"] = text
        user["state"] = "select_priority"
        users[str(chat_id)] = user
        save_json(USERS_FILE, users)
        send_message(chat_id, "üîî –û–±–µ—Ä–∏ —Ä—ñ–≤–µ–Ω—å –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç—É:", reply_markup=inline_priorities())
        return

    if state == "editing_name":
        if text == "–°–∫–∞—Å—É–≤–∞—Ç–∏":
            user["state"] = "main_menu"
            user["editing_task"] = None
            users[str(chat_id)] = user
            save_json(USERS_FILE, users)
            send_message(chat_id, "‚ùå –°–∫–∞—Å–æ–≤–∞–Ω–æ.", reply_markup=main_keyboard_markup())
            return
        tid = user.get("editing_task")
        tasks = load_json(TASKS_FILE)
        if tid and tid in tasks:
            tasks[tid]["name"] = text
            save_json(TASKS_FILE, tasks)
            send_message(chat_id, "‚úÖ –ù–∞–∑–≤—É –∑–º—ñ–Ω–µ–Ω–æ.", reply_markup=main_keyboard_markup())
        else:
            send_message(chat_id, "‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–º—ñ–Ω–∏—Ç–∏ –Ω–∞–∑–≤—É.", reply_markup=main_keyboard_markup())
        user["state"] = "main_menu"
        user["editing_task"] = None
        users[str(chat_id)] = user
        save_json(USERS_FILE, users)
        return

    if state == "editing_category":
        if text == "–°–∫–∞—Å—É–≤–∞—Ç–∏":
            user["state"] = "main_menu"
            user["editing_task"] = None
            users[str(chat_id)] = user
            save_json(USERS_FILE, users)
            send_message(chat_id, "‚ùå –°–∫–∞—Å–æ–≤–∞–Ω–æ.", reply_markup=main_keyboard_markup())
            return
        tid = user.get("editing_task")
        tasks = load_json(TASKS_FILE)
        if tid and tid in tasks:
            tasks[tid]["category"] = text
            save_json(TASKS_FILE, tasks)
            send_message(chat_id, "‚úÖ –ö–∞—Ç–µ–≥–æ—Ä—ñ—é –∑–º—ñ–Ω–µ–Ω–æ.", reply_markup=main_keyboard_markup())
        else:
            send_message(chat_id, "‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–º—ñ–Ω–∏—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é.", reply_markup=main_keyboard_markup())
        user["state"] = "main_menu"
        user["editing_task"] = None
        users[str(chat_id)] = user
        save_json(USERS_FILE, users)
        return

    if state == "editing_description":
        if text in ("–°–∫–∞—Å—É–≤–∞—Ç–∏",):
            user["state"] = "main_menu"
            user["editing_task"] = None
            users[str(chat_id)] = user
            save_json(USERS_FILE, users)
            send_message(chat_id, "‚ùå –°–∫–∞—Å–æ–≤–∞–Ω–æ.", reply_markup=main_keyboard_markup())
            return
        tid = user.get("editing_task")
        tasks = load_json(TASKS_FILE)
        if text == "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç–∏":
            send_message(chat_id, "‚ÑπÔ∏è –û–ø–∏—Å –∑–∞–ª–∏—à–µ–Ω–æ –±–µ–∑ –∑–º—ñ–Ω.", reply_markup=main_keyboard_markup())
        else:
            if tid and tid in tasks:
                tasks[tid]["description"] = text
                save_json(TASKS_FILE, tasks)
                send_message(chat_id, "‚úÖ –û–ø–∏—Å –∑–º—ñ–Ω–µ–Ω–æ.", reply_markup=main_keyboard_markup())
            else:
                send_message(chat_id, "‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–º—ñ–Ω–∏—Ç–∏ –æ–ø–∏—Å.", reply_markup=main_keyboard_markup())
        user["state"] = "main_menu"
        user["editing_task"] = None
        users[str(chat_id)] = user
        save_json(USERS_FILE, users)
        return

    if state == "editing_priority":
        if text == "–°–∫–∞—Å—É–≤–∞—Ç–∏":
            user["state"] = "main_menu"
            user["editing_task"] = None
            users[str(chat_id)] = user
            save_json(USERS_FILE, users)
            send_message(chat_id, "‚ùå –°–∫–∞—Å–æ–≤–∞–Ω–æ.", reply_markup=main_keyboard_markup())
            return
        if text not in PRIORITIES:
            send_message(chat_id, "‚ö†Ô∏è –û–±–µ—Ä—ñ—Ç—å –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç –∫–Ω–æ–ø–∫–æ—é.", reply_markup=inline_priorities())
            return
        tid = user.get("editing_task")
        tasks = load_json(TASKS_FILE)
        if tid and tid in tasks:
            tasks[tid]["priority"] = text
            save_json(TASKS_FILE, tasks)
            send_message(chat_id, "‚úÖ –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç –∑–º—ñ–Ω–µ–Ω–æ.", reply_markup=main_keyboard_markup())
        else:
            send_message(chat_id, "‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–º—ñ–Ω–∏—Ç–∏ –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç.", reply_markup=main_keyboard_markup())
        user["state"] = "main_menu"
        user["editing_task"] = None
        users[str(chat_id)] = user
        save_json(USERS_FILE, users)
        return
    if state == "custom_category":
        if text == "–°–∫–∞—Å—É–≤–∞—Ç–∏":
            user["state"] = "main_menu"
            user["temp_task"] = {}
            users[str(chat_id)] = user
            save_json(USERS_FILE, users)
            send_message(chat_id, "‚ùå –°–∫–∞—Å–æ–≤–∞–Ω–æ.", reply_markup=main_keyboard_markup())
            return
        user["temp_task"]["category"] = text
        user["state"] = "enter_description"
        users[str(chat_id)] = user
        save_json(USERS_FILE, users)
        send_message(chat_id, "üìù –í–≤–µ–¥–∏ –æ–ø–∏—Å –∑–∞–≤–¥–∞–Ω–Ω—è (–∞–±–æ –Ω–∞–ø–∏—à–∏ '–ü—Ä–æ–ø—É—Å—Ç–∏—Ç–∏'):", reply_markup=main_keyboard_markup())
        return
    if text == "–°–∫–∞—Å—É–≤–∞—Ç–∏":
        user["state"] = "main_menu"
        user["temp_task"] = {}
        user["editing_task"] = None
        users[str(chat_id)] = user
        save_json(USERS_FILE, users)
        send_message(chat_id, "‚ùå –°–∫–∞—Å–æ–≤–∞–Ω–æ.", reply_markup=main_keyboard_markup())
        return

    send_message(chat_id, "üôÉ –ù–µ –∑–æ–≤—Å—ñ–º –∑—Ä–æ–∑—É–º—ñ–≤. –°–∫–æ—Ä–∏—Å—Ç–∞–π—Å—è –º–µ–Ω—é:", reply_markup=main_keyboard_markup())

def check_and_send_reminders():
    tasks = load_json(TASKS_FILE)
    now = datetime.date.today()
    tomorrow = now + datetime.timedelta(days=1)
    for tid, task in list(tasks.items()):
        if task.get("status") == "–∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–µ" and not task.get("reminder_sent", False):
            try:
                due_date = datetime.date.fromisoformat(task.get("date"))
            except Exception:
                continue
            if due_date == tomorrow:
                # send reminder to user
                uid = task.get("user_id")
                text = f"üîî –ù–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è: –∑–∞–≤–¥–∞–Ω–Ω—è ¬´{task.get('name')}¬ª –º–∞—î –¥–µ–¥–ª–∞–π–Ω –∑–∞–≤—Ç—Ä–∞ ({task.get('date')})."
                send_message(uid, text, reply_markup=main_keyboard_markup())
                tasks[tid]["reminder_sent"] = True
    save_json(TASKS_FILE, tasks)

def main():
    ensure_data_dir()
    offset = None
    last_reminder_check = 0
    print("ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω–æ! –û—á—ñ–∫—É–≤–∞–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å...")
    while True:
        try:
            url = BASE_URL + "getUpdates"
            if offset:
                url += f"?offset={offset}"
            with urllib.request.urlopen(url, timeout=60) as response:
                data = json.loads(response.read().decode("utf-8"))
            for update in data.get("result", []):
                offset = update["update_id"] + 1
                if "callback_query" in update:
                    try:
                        handle_callback(update)
                    except Exception as e:
                        print("callback handling error:", e)
                        traceback.print_exc()
                else:
                    try:
                        process_message(update)
                    except Exception as e:
                        print("message handling error:", e)
                        traceback.print_exc()
            now_ts = time.time()
            if now_ts - last_reminder_check >= REMINDER_INTERVAL_SECONDS:
                try:
                    check_and_send_reminders()
                except Exception as e:
                    print("reminder check error:", e)
                last_reminder_check = now_ts
        except Exception as e:
            print("Main loop error:", e)
            traceback.print_exc()
            time.sleep(2)
        time.sleep(0.3)

if __name__ == "__main__":
    main()
